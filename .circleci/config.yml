version: 2

jobs:
  build:
    machine: true
    steps:
      - checkout
      - restore_cache:
          keys:
            - docker-cache-{{ checksum "Dockerfile" }}-{{ checksum "src/Gemfile.lock" }}
          paths:
            - ~/caches/images.tar
      - run:
          command: |
            if [[ -e ~/caches/images.tar ]]; then
              docker load -i ~/caches/images.tar
            fi
          name: docker load
      - run:
          command: docker-compose up -d --build
          name: docker up
      - run:
          command: mkdir -p ~/caches
          name: mkdir -p ~/caches
      - run:
          command: |
            if [[ ! -e ~/caches/images.tar ]]; then
              docker save -o ~/caches/images.tar $(docker images --filter "dangling=false" --format "{{.Repository}}:{{.Tag}}")
            fi
          name: docker save
      - save_cache:
          key: docker-cache-{{ checksum "Dockerfile" }}-{{ checksum "src/Gemfile.lock" }}
          paths:
            - ~/caches/images.tar
      - run:
          command: docker-compose run -u 1001:1001 rails dockerize -wait tcp://mysql:3306 -timeout 120s
          name: wait for db
  test:
    machine: true
    steps:
      - checkout
      - run: 
          command: docker-compose run -u 1001:1001 rails bundle exec rake db:create db:migrate db:seed RAILS_ENV=test
          name: db setup
      - run:
          command: docker-compose run -u 1001:1001 rails bundle exec rake test
          name: rails test
  rubocop:
    machine: true
    steps:
      - checkout
      - restore_cache:
          keys:
            - docker-cache-{{ checksum "Dockerfile" }}-{{ checksum "src/Gemfile.lock" }}
          paths:
            - ~/caches/images.tar
      - run: 
          command: cd ./src
          name: cd src
      - run: 
          command: bundle exec rubocop
          name: rubocop

workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - test:
          requires:
            - build
      - rubocop:
          requires:
            - build
